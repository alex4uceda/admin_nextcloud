upstream nextcloud.net {
  # El contenedor se llama "nextcloud-app" en tu compose
  server nextcloud-app:80;
  keepalive 32;
}

server {
  listen 80;
  server_name _;

  # Seguridad recomendada por Nextcloud
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;
  add_header X-XSS-Protection "1; mode=block";
  add_header Referrer-Policy no-referrer;
  add_header X-Download-Options noopen;
  add_header X-Permitted-Cross-Domain-Policies none;

  # Real IP / Host para app detrás de proxy
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Port  $server_port;

  # Redirecciones well-known para caldav/carddav
  location = /.well-known/carddav  { return 301 /remote.php/carddav;  }
  location = /.well-known/caldav   { return 301 /remote.php/caldav;   }
  location = /.well-known/webfinger { return 301 /index.php/.well-known/webfinger; }
  location = /.well-known/nodeinfo  { return 301 /index.php/.well-known/nodeinfo;  }

  # Websocket (notify_push) si lo tienes
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  location ^~ /push/ {
    proxy_pass http://nextcloud.net;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }

  # Resto de rutas a Nextcloud
  location / {
    proxy_pass http://nextcloud.net;
    proxy_http_version 1.1;

    # No caches incorrectas para WebDAV
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_request_buffering off;
  }

  # Archivos estáticos – opcionalmente puedes habilitar cache corto:
  location ~* \.(?:css|js|woff2?|svg|gif|ico|png|jpg|jpeg)$ {
    proxy_pass http://nextcloud.net;
    expires 1h;
    access_log off;
  }
}
