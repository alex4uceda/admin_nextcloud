#!/bin/bash

# Script para generar visualizaciรณn de diagramas sin PlantUML

echo "======================================"
echo "๐๏ธ  NEXTCLOUD INFRASTRUCTURE DIAGRAMS"
echo "======================================"
echo ""

echo "๐ INFRASTRUCTURE OVERVIEW"
echo "=========================="
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    HOST SYSTEM (Linux)                     โ"
echo "โ                                                             โ"
echo "โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ"
echo "โ  โ            Docker Network: proxy_net_next             โ  โ"
echo "โ  โ                                                       โ  โ"
echo "โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ   โ  โ"
echo "โ  โ  โ CoreDNS  โ  โnginx-proxy โ  โ   Nextcloud     โ   โ  โ"
echo "โ  โ  โ :53      โ  โ :80,:443   โ  โ   Apache+PHP    โ   โ  โ"
echo "โ  โ  โ          โ  โ            โ  โ   :80           โ   โ  โ"
echo "โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโ   โ  โ"
echo "โ  โ                                                       โ  โ"
echo "โ  โ  โโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโโ   โ  โ"
echo "โ  โ  โ MariaDB  โ              โ      Redis          โ   โ  โ"
echo "โ  โ  โ :3306    โ              โ      :6379          โ   โ  โ"
echo "โ  โ  โ          โ              โ                     โ   โ  โ"
echo "โ  โ  โโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโโ   โ  โ"
echo "โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ"
echo "โ                                                             โ"
echo "โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ"
echo "โ  โ              Volume Mounts                            โ  โ"
echo "โ  โ  ./nextcloud/     ./db/        ./redis/              โ  โ"
echo "โ  โ  ./nextcloud_data/ ./swag-config/ ./coredns/         โ  โ"
echo "โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "๐ DEPLOYMENT FLOW"
echo "=================="
echo ""
echo "Administrator โ start.sh โ System DNS Config โ Docker Network"
echo "                     โ"
echo "              CoreDNS Started โ SSL Generation โ Database Setup"
echo "                     โ"
echo "              Nextcloud App โ nginx-proxy โ Client Access"
echo "                     โ"
echo "              Health Checks โ Monitoring โ Production Ready"
echo ""

echo "๐ NETWORK ARCHITECTURE"
echo "======================="
echo ""
echo "Internet โ โ Host:53,80,443 โ โ Docker Network โ โ Containers"
echo "                                       โ"
echo "Client โ โ DNS Resolution โ โ CoreDNS:53"
echo "       โ โ HTTPS Request โ โ nginx-proxy:443 โ โ Nextcloud:80"
echo "                                                      โ"
echo "                                              MariaDB:3306"
echo "                                                      โ"
echo "                                               Redis:6379"
echo ""

echo "๐ SYSTEM STATES"
echo "================"
echo ""
echo "[SystemClean] โ [DNSConfiguring] โ [DNSActive] โ [SSLGenerating]"
echo "                                                         โ"
echo "[FullyOperational] โ [ServicesStarting] โ [SSLReady] โโโโ"
echo "        โ                                                  "
echo "[Maintenance] โ โ [ErrorState] โ [Troubleshooting]"
echo "        โ                                                  "
echo "[Stopping] โ [SystemStopped]"
echo ""

echo "๐ KEY COMPONENTS"
echo "=================="
echo ""
echo "๐ DNS Service (CoreDNS)"
echo "   โข Resolves nextcloud.net โ 127.0.0.1"
echo "   โข Handles *.nextcloud.net wildcard"
echo "   โข Forwards external queries to 1.1.1.1, 8.8.8.8"
echo "   โข Port 53/UDP, 53/TCP"
echo ""
echo "๐ SSL/TLS (nginx-proxy)"
echo "   โข Self-signed wildcard certificates"
echo "   โข HTTPS termination on port 443"
echo "   โข HTTP redirect from port 80"
echo "   โข Reverse proxy to Nextcloud"
echo ""
echo "โ๏ธ  Application (Nextcloud)"
echo "   โข Apache + PHP runtime"
echo "   โข Nextcloud application"
echo "   โข File storage and user data"
echo "   โข Admin interface"
echo ""
echo "๐๏ธ  Database (MariaDB)"
echo "   โข Nextcloud database backend"
echo "   โข User data and configurations"
echo "   โข Transaction isolation"
echo "   โข Health monitoring"
echo ""
echo "โก Cache (Redis)"
echo "   โข Session storage"
echo "   โข Application cache"
echo "   โข Performance optimization"
echo "   โข Password protected"
echo ""

echo "๐ QUICK START COMMANDS"
echo "======================="
echo ""
echo "# Complete setup:"
echo "sudo ./start.sh"
echo ""
echo "# Generate SSL certificates:"
echo "./generate-ssl-certs.sh"
echo ""
echo "# Install system certificates:"
echo "sudo ./install-ssl-cert-system.sh"
echo ""
echo "# Start services:"
echo "docker-compose up -d"
echo ""
echo "# Check status:"
echo "docker-compose ps"
echo ""
echo "# View logs:"
echo "docker-compose logs -f"
echo ""
echo "# Test DNS:"
echo "dig nextcloud.net @127.0.0.1"
echo ""
echo "# Access Nextcloud:"
echo "https://nextcloud.net"
echo ""

echo "๐ TROUBLESHOOTING"
echo "=================="
echo ""
echo "# DNS issues:"
echo "sudo ./coredns/INSTALACION/DESACTIVAR_SYSTEM_SESOLVE.sh"
echo "docker-compose restart coredns"
echo ""
echo "# SSL issues:"
echo "./generate-ssl-certs.sh"
echo "docker-compose restart nginx-proxy"
echo ""
echo "# Service issues:"
echo "docker-compose down && docker-compose up -d"
echo ""
echo "# Port conflicts:"
echo "sudo lsof -i :53,:80,:443"
echo ""

echo "======================================"
echo "โ Infrastructure Documentation Ready"
echo "======================================"