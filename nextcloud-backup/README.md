# üîê Nextcloud Backup Service

Servicio automatizado de backup para la infraestructura Nextcloud con conexi√≥n encriptada SSH y sincronizaci√≥n via RSYNC.

## üìã Caracter√≠sticas

- **üîí Conexi√≥n Encriptada**: Transferencias seguras via SSH/SFTP
- **üìä Backup de Base de Datos**: Respaldo completo de MySQL/MariaDB
- **üìÅ Sincronizaci√≥n de Archivos**: RSYNC incremental y completo
- **‚è∞ Programaci√≥n Autom√°tica**: Cron jobs configurables
- **üóÇÔ∏è Retenci√≥n Configurable**: Limpieza autom√°tica de backups antiguos
- **‚úÖ Verificaci√≥n de Integridad**: Checksums y validaci√≥n de backups
- **üìù Logging Detallado**: Monitoreo y diagn√≥stico completo
- **üîß Health Checks**: Verificaci√≥n autom√°tica del estado del servicio

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    NEXTCLOUD INFRASTRUCTURE                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   MariaDB       ‚îÇ   Nextcloud     ‚îÇ      Redis Cache        ‚îÇ
‚îÇ   (DB Data)     ‚îÇ   (App + Data)  ‚îÇ     (Cache Data)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                 ‚îÇ                      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ      BACKUP SERVICE CONTAINER      ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  üîß rsync + mysqldump + ssh       ‚îÇ
         ‚îÇ  ‚è∞ cron + health checks          ‚îÇ
         ‚îÇ  üìù logging + compression         ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ SSH/RSYNC Encrypted
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ       REMOTE BACKUP SERVER        ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  üìÅ /backups/db/                  ‚îÇ
         ‚îÇ  üìÅ /backups/files/current/       ‚îÇ
         ‚îÇ  üìÅ /backups/files/YYYYMMDD/      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Instalaci√≥n R√°pida

### 1. Ejecutar Script de Configuraci√≥n Autom√°tica

```bash
cd /home/uceda/Documents/PROYECTO_V1
./nextcloud-backup/setup.sh
```

El script automatiza:
- ‚úÖ Generaci√≥n de llaves SSH
- ‚úÖ Configuraci√≥n de variables de entorno
- ‚úÖ Prueba de conectividad al servidor remoto
- ‚úÖ Construcci√≥n del contenedor Docker

### 2. Iniciar el Servicio

```bash
# Iniciar solo el servicio de backup
docker compose up -d nextcloud-backup

# O iniciar toda la infraestructura
docker compose up -d
```

## ‚öôÔ∏è Configuraci√≥n Manual

### 1. Configurar Servidor Remoto

En tu servidor de backup remoto:

```bash
# Crear usuario dedicado
sudo useradd -m -s /bin/bash nextcloud-backup

# Crear directorio de backups
sudo mkdir -p /home/nextcloud-backup/backups
sudo chown nextcloud-backup:nextcloud-backup /home/nextcloud-backup/backups

# Configurar SSH
sudo mkdir /home/nextcloud-backup/.ssh
sudo chmod 700 /home/nextcloud-backup/.ssh
```

### 2. Generar y Configurar Llaves SSH

```bash
# Generar llaves SSH
ssh-keygen -t rsa -b 4096 -f ./nextcloud-backup/ssh-keys/id_rsa

# Copiar llave p√∫blica al servidor remoto
ssh-copy-id -i ./nextcloud-backup/ssh-keys/id_rsa.pub nextcloud-backup@your-server.com

# Probar conexi√≥n
ssh -i ./nextcloud-backup/ssh-keys/id_rsa nextcloud-backup@your-server.com "echo 'OK'"
```

### 3. Configurar Variables de Entorno

Agrega estas variables a tu archivo `.env`:

```bash
# Configuraci√≥n del servidor remoto
BACKUP_REMOTE_HOST=your-backup-server.com
BACKUP_REMOTE_USER=nextcloud-backup
BACKUP_REMOTE_PORT=22
BACKUP_REMOTE_PATH=/home/nextcloud-backup/backups

# Configuraci√≥n de backup
BACKUP_RETENTION_DAYS=30
BACKUP_COMPRESSION=true
BACKUP_VERIFY_CHECKSUMS=true
BACKUP_RUN_INITIAL=false
LOG_RETENTION_DAYS=7
```

## üìÖ Programaci√≥n de Backups

### Horarios por Defecto

- **Backup Completo**: Diario a las 2:00 AM
- **Backup Incremental**: Cada 6 horas (6:00, 12:00, 18:00, 00:00)
- **Limpieza de Logs**: Semanal (domingos 3:00 AM)
- **Health Check**: Cada hora

### Personalizar Horarios

Edita el archivo `./nextcloud-backup/config/crontab`:

```bash
# Backup completo cada 12 horas
0 */12 * * * /app/scripts/backup-full.sh >> /app/logs/backup.log 2>&1

# Backup incremental cada 2 horas (solo d√≠as laborables)
0 */2 * * 1-5 /app/scripts/backup-incremental.sh >> /app/logs/backup.log 2>&1
```

## üîß Uso y Comandos

### Ejecutar Backups Manualmente

```bash
# Backup completo
docker compose exec nextcloud-backup /app/scripts/backup-full.sh

# Backup incremental
docker compose exec nextcloud-backup /app/scripts/backup-incremental.sh

# Health check
docker compose exec nextcloud-backup /app/scripts/health-check.sh
```

### Monitoreo y Logs

```bash
# Ver logs en tiempo real
docker compose logs -f nextcloud-backup

# Ver logs espec√≠ficos
docker compose exec nextcloud-backup tail -f /app/logs/backup.log
docker compose exec nextcloud-backup tail -f /app/logs/error.log
docker compose exec nextcloud-backup tail -f /app/logs/health.log

# Estado del servicio
docker compose ps nextcloud-backup
```

### Gesti√≥n del Contenedor

```bash
# Reiniciar servicio
docker compose restart nextcloud-backup

# Reconstruir contenedor
docker compose build nextcloud-backup
docker compose up -d nextcloud-backup

# Acceder al contenedor
docker compose exec nextcloud-backup /bin/bash
```

## üìÇ Estructura de Backups

### Servidor Remoto

```
/home/nextcloud-backup/backups/
‚îú‚îÄ‚îÄ db/                           # Backups de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ nextcloud_db_20241101_020000.sql.gz
‚îÇ   ‚îú‚îÄ‚îÄ nextcloud_db_20241101_020000.sql.gz.md5
‚îÇ   ‚îî‚îÄ‚îÄ nextcloud_db_20241102_020000.sql.gz
‚îú‚îÄ‚îÄ files/                        # Backups de archivos
‚îÇ   ‚îú‚îÄ‚îÄ current/                  # Sincronizaci√≥n incremental actual
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nextcloud/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nextcloud_data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis/
‚îÇ   ‚îú‚îÄ‚îÄ 20241101_020000/          # Snapshot completo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nextcloud/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nextcloud_data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backup_metadata.json
‚îÇ   ‚îî‚îÄ‚îÄ incremental_20241101_080000/ # Cambios incrementales
‚îî‚îÄ‚îÄ *.json                        # Metadatos de backups incrementales
```

### Local (Temporal)

```
./nextcloud-backup/
‚îú‚îÄ‚îÄ logs/                         # Logs del servicio
‚îÇ   ‚îú‚îÄ‚îÄ backup.log
‚îÇ   ‚îú‚îÄ‚îÄ error.log
‚îÇ   ‚îî‚îÄ‚îÄ health.log
‚îú‚îÄ‚îÄ ssh-keys/                     # Llaves SSH
‚îÇ   ‚îú‚îÄ‚îÄ id_rsa
‚îÇ   ‚îî‚îÄ‚îÄ id_rsa.pub
‚îî‚îÄ‚îÄ config/                       # Configuraci√≥n
    ‚îú‚îÄ‚îÄ crontab
    ‚îî‚îÄ‚îÄ backup.conf
```

## üîç Troubleshooting

### Problemas Comunes

**‚ùå Error de conexi√≥n SSH:**
```bash
# Verificar conectividad
ssh -i ./nextcloud-backup/ssh-keys/id_rsa user@server "echo OK"

# Verificar permisos
ls -la ./nextcloud-backup/ssh-keys/
```

**‚ùå Error de permisos en servidor remoto:**
```bash
# En el servidor remoto
sudo chown -R nextcloud-backup:nextcloud-backup /home/nextcloud-backup/
sudo chmod 755 /home/nextcloud-backup/.ssh
sudo chmod 600 /home/nextcloud-backup/.ssh/authorized_keys
```

**‚ùå Error de base de datos:**
```bash
# Verificar conectividad a MySQL
docker compose exec nextcloud-backup nc -z db 3306

# Verificar credenciales
docker compose exec nextcloud-backup mysql -h db -u $MYSQL_USER -p$MYSQL_PASSWORD -e "SHOW DATABASES;"
```

**‚ùå Espacio insuficiente:**
```bash
# Verificar espacio local
df -h ./

# Verificar espacio remoto
ssh user@server "df -h /home/nextcloud-backup/"

# Limpiar backups antiguos manualmente
docker compose exec nextcloud-backup /app/scripts/cleanup-logs.sh
```

### Logs de Diagn√≥stico

```bash
# Debug completo
docker compose exec nextcloud-backup /bin/bash -c "
echo '=== CONFIGURACI√ìN ==='
env | grep BACKUP_
echo '=== CONECTIVIDAD ==='
nc -z db 3306 && echo 'DB OK' || echo 'DB ERROR'
echo '=== SSH ==='
ssh -o ConnectTimeout=5 \$BACKUP_REMOTE_USER@\$BACKUP_REMOTE_HOST 'echo SSH_OK' 2>&1
echo '=== ESPACIO ==='
df -h /backups
"
```

## üîß Configuraci√≥n Avanzada

### Variables de Entorno Adicionales

```bash
# Performance
RSYNC_BANDWIDTH_LIMIT=1000        # KB/s
PARALLEL_COMPRESSION=true
COMPRESSION_LEVEL=6               # 1-9

# Seguridad
SSH_CONNECTION_TIMEOUT=30
VERIFY_BACKUP_INTEGRITY=true
VERIFY_REMOTE_CHECKSUMS=true

# Notificaciones
NOTIFICATIONS_ENABLED=false
NOTIFICATION_EMAIL=admin@example.com
NOTIFICATION_ON_ERROR=true
```

### Personalizar Scripts

Los scripts est√°n en `./nextcloud-backup/scripts/` y pueden modificarse seg√∫n necesidades espec√≠ficas:

- `backup-full.sh` - Backup completo
- `backup-incremental.sh` - Backup incremental
- `health-check.sh` - Verificaciones de salud
- `cleanup-logs.sh` - Limpieza de logs

## üìä Monitoreo y Alertas

### Health Checks HTTP (Opcional)

Si habilitas el puerto 8080, puedes acceder a:

```bash
# Status endpoint
curl http://localhost:8080/health

# Metrics endpoint
curl http://localhost:8080/metrics
```

### Integraci√≥n con Monitoring

El servicio genera logs en formato estructurado compatible con:
- **Prometheus** (m√©tricas)
- **Grafana** (dashboards)
- **ELK Stack** (an√°lisis de logs)

## üö® Seguridad

### Mejores Pr√°cticas

‚úÖ **Usar llaves SSH dedicadas** (no reutilizar llaves personales)
‚úÖ **Configurar usuario dedicado** en servidor remoto
‚úÖ **Restringir permisos SSH** (solo backup, no shell interactivo)
‚úÖ **Encriptar backups** en tr√°nsito (SSH) y reposo (opcional)
‚úÖ **Monitorear accesos** SSH en servidor remoto
‚úÖ **Rotar llaves SSH** peri√≥dicamente

### Configuraci√≥n SSH Restrictiva

En el servidor remoto (`/home/nextcloud-backup/.ssh/authorized_keys`):

```bash
command="/usr/bin/rsync --server",no-port-forwarding,no-X11-forwarding,no-agent-forwarding ssh-rsa AAAAB3...
```

## üîÑ Restauraci√≥n de Backups

### Restaurar Base de Datos

```bash
# Descomprimir backup
gunzip nextcloud_db_YYYYMMDD_HHMMSS.sql.gz

# Restaurar a la base de datos
mysql -h db -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE < nextcloud_db_YYYYMMDD_HHMMSS.sql
```

### Restaurar Archivos

```bash
# Sincronizar desde backup completo
rsync -av user@server:/path/to/backup/files/YYYYMMDD_HHMMSS/ ./restore/

# Restaurar a Nextcloud
cp -r ./restore/nextcloud/* ./nextcloud/
cp -r ./restore/nextcloud_data/* ./nextcloud_data/
```

## üìû Soporte

Para problemas o mejoras:

1. Verificar logs: `/app/logs/`
2. Ejecutar health check: `/app/scripts/health-check.sh`
3. Revisar configuraci√≥n de red y SSH
4. Consultar documentaci√≥n de troubleshooting

---

**üîê Nextcloud Backup Service** - Respaldo seguro y automatizado para tu infraestructura Nextcloud.